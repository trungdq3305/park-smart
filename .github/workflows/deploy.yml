name: CI/CD Pipeline

on:
  push:
    branches: ["master"]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      # ðŸ”¹ Build thá»­ cÃ¡c service Ä‘á»ƒ Ä‘áº£m báº£o khÃ´ng lá»—i
      - name: Build CoreService
        run: docker build -t coreservice-test -f backend/Services/CoreService/Dockerfile .

      - name: Build ParkingService
        run: docker build -t parkingservice-test ./backend/Services/parking-service

      - name: Build OcelotGateway
        run: docker build -t ocelotgateway-test -f backend/Gateway/OcelotGateway/Dockerfile .

      # ðŸ”¹ Náº¿u build ok háº¿t má»›i copy lÃªn VPS
      - name: Copy source to VPS
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          username: root
          password: ${{ secrets.VPS_PASSWORD }}
          source: ./backend,./docker-compose.yml,./backend/Gateway/OcelotGateway/OcelotGateway/ocelot.json
          target: "/var/www/park-smart"
          overwrite: true

      - name: Deploy on VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: root
          password: ${{ secrets.VPS_PASSWORD }}
          script: |
            cd /var/www/park-smart

            echo ">>> Preparing environment files..."
            # Táº¡o thÆ° má»¥c náº¿u chÆ°a cÃ³
            mkdir -p ./backend/Services/CoreService
            mkdir -p ./backend/Services/parking-service

            # Táº¡o file .env cho CoreService (Pháº£i cÃ³ Ä‘á»ƒ docker-compose khÃ´ng lá»—i)
            # Náº¿u CoreService khÃ´ng cáº§n secret tá»« GitHub, chá»‰ cáº§n touch Ä‘á»ƒ táº¡o file trá»‘ng
            touch ./backend/Services/CoreService/.env

            # Táº¡o file .env cho ParkingService
            cat <<EOF > ./backend/Services/parking-service/.env
            PORT=${{ secrets.PORT }}
            MONGO_URI=${{ secrets.MONGO_URI }}
            JWT_SECRET=${{ secrets.JWT_SECRET }}
            EMAIL_USER=${{ secrets.EMAIL_USER }}
            EMAIL_APP_PASSWORD=${{ secrets.EMAIL_APP_PASSWORD }}
            SMTP_HOST=${{ secrets.SMTP_HOST }}
            SMTP_PORT=${{ secrets.SMTP_PORT }}
            APP_NAME=${{ secrets.APP_NAME }}
            CORE_SERVICE_URL=${{ secrets.CORE_SERVICE_URL }}
            GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}
            EOF

            echo ">>> Cleaning up system..."
            # ThÃªm flag --remove-orphans Ä‘á»ƒ dá»n dáº¹p cÃ¡c container rÃ¡c
            docker compose down --remove-orphans || true
            
            # Ã‰p xÃ³a container náº¿u lá»‡nh down phÃ­a trÃªn bá»‹ káº¹t (phÃ²ng há»)
            docker rm -f coreservice parkingservice ocelotgateway || true

            # XÃ³a image cÅ© Ä‘á»ƒ Ä‘áº£m báº£o khÃ´ng dÃ¹ng cache sai
            docker rmi coreservice parkingservice ocelotgateway || true

            echo ">>> Building and Starting services..."
            # KhÃ´ng cáº§n --no-cache náº¿u Ä‘Ã£ rmi phÃ­a trÃªn, nhÆ°ng giá»¯ --build vÃ  --force-recreate lÃ  Ä‘Ãºng
            docker compose up -d --build --force-recreate

            echo ">>> Cleaning up dangling images to save disk space..."
            docker image prune -f
            
            echo ">>> Current Status:"
            docker ps
            echo ">>> Deployment finished."